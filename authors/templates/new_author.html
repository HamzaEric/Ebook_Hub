{% extends "base.html" %}

{% block title %}Add Author - Ebook Hub{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a href="{% url 'books_list' %}" class="text-decoration-none">
                <i class="bi bi-house me-1"></i>Library
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'authors_list' %}" class="text-decoration-none">
                Authors
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">
            Add Author
        </li>
    </ol>
</nav>

<div class="row align-items-center mb-4">
    <div class="col">
        <h1 class="h2 text-primary mb-1">
            <i class="bi bi-person-plus me-2"></i>Add New Author
        </h1>
        <p class="text-muted mb-0">Add a new writer to your digital library</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-0 shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-person-badge me-2"></i>Author Information
                </h5>
            </div>

            <div class="card-body p-4">
                {% if form.errors %}
                <div class="alert alert-danger d-flex align-items-start mb-4" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2 mt-1"></i>
                    <div>
                        <strong>Please correct the errors below:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Fields marked with * are required</li>
                        </ul>
                    </div>
                </div>
                {% endif %}

                <form method="POST" enctype="multipart/form-data" id="authorForm" novalidate>
                    {% csrf_token %}

                    <div class="row g-4">
                        <div class="col-12">
                            <label for="id_name" class="form-label fw-semibold">
                                <i class="bi bi-person me-2 text-primary"></i>Full Name *
                            </label>
                            <input type="text" class="form-control form-control-lg" id="id_name" name="name"
                                placeholder="Enter author's full name" required>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Full name of the writer (e.g., Ernest Hemingway)
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="id_birth_date" class="form-label fw-semibold">
                                <i class="bi bi-calendar3 me-2 text-primary"></i>Birth Date
                            </label>
                            <input type="date" class="form-control form-control-lg" id="id_birth_date"
                                name="birth_date">
                            <div class="form-text">
                                <i class="bi bi-cake me-1"></i>
                                Author's date of birth
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="id_nationality" class="form-label fw-semibold">
                                <i class="bi bi-geo-alt me-2 text-primary"></i>Nationality
                            </label>
                            <input type="text" class="form-control form-control-lg" id="id_nationality"
                                name="nationality" placeholder="Ex: American, British, Brazilian"
                                list="nationalityList">
                            <datalist id="nationalityList">
                                <option value="American">
                                <option value="British">
                                <option value="Brazilian">
                                <option value="Portuguese">
                                <option value="French">
                                <option value="Spanish">
                                <option value="Argentinian">
                                <option value="German">
                                <option value="Italian">
                                <option value="Japanese">
                            </datalist>
                            <div class="form-text">
                                <i class="bi bi-flag me-1"></i>
                                Author's country of origin
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="id_biography" class="form-label fw-semibold">
                                <i class="bi bi-journal-text me-2 text-primary"></i>Biography
                            </label>
                            <textarea class="form-control" id="id_biography" name="biography" rows="5"
                                placeholder="Write a brief biography of the author: life, major works, awards, literary style, influences..."></textarea>
                            <div class="form-text">
                                <i class="bi bi-chat-left-text me-1"></i>
                                Relevant history and information about the author
                                <span class="float-end text-muted" id="bioCharCount">0/2000 characters</span>
                               <br>* If left empty, an AI mini-biography will be generated automatically
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="id_photo" class="form-label fw-semibold">
                                <i class="bi bi-image me-2 text-primary"></i>Author Photo
                            </label>
                            <div class="card border-2 border-dashed">
                                <div class="card-body text-center py-4">
                                    <div class="mb-3">
                                        <i class="bi bi-person-circle text-muted" style="font-size: 4rem;"></i>
                                    </div>
                                    <input type="file" class="form-control" id="id_photo" name="photo" accept="image/*">
                                    <div class="form-text mt-3">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Accepted formats: JPG, PNG, GIF (max 5MB)
                                    </div>

                                    <div id="imagePreview" class="mt-3" style="display: none;">
                                        <img id="previewImg" class="img-thumbnail rounded-circle"
                                            style="max-height: 200px; max-width: 200px; object-fit: cover;">
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                onclick="removeImage()">
                                                <i class="bi bi-trash me-1"></i>Remove Photo
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info d-flex align-items-center mt-4">
                        <i class="bi bi-asterisk me-2"></i>
                        <small>Fields marked with * are required</small>
                    </div>

                    <div class="row g-3 mt-4">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-secondary btn-lg w-100"
                                onclick="window.history.back()">
                                <i class="bi bi-arrow-left me-2"></i>Back
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="reset" class="btn btn-outline-warning btn-lg w-100"
                                onclick="return confirm('Are you sure you want to clear all fields?')">
                                <i class="bi bi-arrow-clockwise me-2"></i>Clear All
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-primary btn-lg w-100" id="submitBtn">
                                <i class="bi bi-check-circle me-2"></i>Add Author
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="card border-0 bg-light mt-4">
            <div class="card-body">
                <h6 class="fw-bold text-primary mb-3">
                    <i class="bi bi-lightbulb me-2"></i>Tips for a good entry:
                </h6>
                <div class="row g-3">
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Use the author's full name
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Include birth date when possible
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Specify nationality correctly
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Write an informative biography
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Use a high-quality photo
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check2 text-success me-2"></i>
                                Mention works and awards in bio
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('authorForm');
        const submitBtn = document.getElementById('submitBtn');
        const biographyField = document.getElementById('id_biography');
        const bioCharCount = document.getElementById('bioCharCount');
        const photoInput = document.getElementById('id_photo');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');

        // Character counter for biography
        if (biographyField && bioCharCount) {
            biographyField.addEventListener('input', function () {
                const currentLength = this.value.length;
                const maxLength = 2000;
                bioCharCount.textContent = `${currentLength}/${maxLength} characters`;

                if (currentLength > maxLength * 0.9) {
                    bioCharCount.classList.add('text-warning');
                } else {
                    bioCharCount.classList.remove('text-warning');
                }

                if (currentLength > maxLength) {
                    bioCharCount.classList.add('text-danger');
                    this.value = this.value.substring(0, maxLength);
                } else {
                    bioCharCount.classList.remove('text-danger');
                }
            });
        }

        // Image preview functionality
        if (photoInput) {
            photoInput.addEventListener('change', function (e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file size (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('File too large! Please select an image smaller than 5MB.');
                        this.value = '';
                        return;
                    }

                    // Validate file type
                    if (!file.type.startsWith('image/')) {
                        alert('Please select only image files.');
                        this.value = '';
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        previewImg.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Form submission handling
        form.addEventListener('submit', function (e) {
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';

            // Restore if there's an error (fallback)
            setTimeout(() => {
                if (submitBtn.disabled) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }, 10000);
        });

        // Form validation
        const requiredFields = document.querySelectorAll('input[required]');
        requiredFields.forEach(field => {
            field.addEventListener('blur', function () {
                validateField(this);
            });

            field.addEventListener('input', function () {
                if (this.classList.contains('is-invalid')) {
                    validateField(this);
                }
            });
        });

        function validateField(field) {
            if (field.hasAttribute('required') && !field.value.trim()) {
                field.classList.add('is-invalid');
                field.classList.remove('is-valid');
            } else if (field.value.trim()) {
                field.classList.remove('is-invalid');
                field.classList.add('is-valid');
            } else {
                field.classList.remove('is-invalid', 'is-valid');
            }
        }

        // Birth date validation (cannot be future)
        const birthDateField = document.getElementById('id_birth_date');
        if (birthDateField) {
            birthDateField.addEventListener('change', function () {
                const selectedDate = new Date(this.value);
                const today = new Date();

                if (selectedDate > today) {
                    alert('Birth date cannot be in the future.');
                    this.value = '';
                    this.classList.add('is-invalid');
                } else if (this.value) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                }
            });

            // Set max date to today
            const today = new Date().toISOString().split('T')[0];
            birthDateField.setAttribute('max', today);
        }

        // Auto-focus on first field
        const firstField = document.getElementById('id_name');
        if (firstField) {
            firstField.focus();
        }

        // Reset form confirmation
        const resetBtn = document.querySelector('button[type="reset"]');
        if (resetBtn) {
            resetBtn.addEventListener('click', function (e) {
                const confirmed = confirm('Are you sure you want to clear all fields?\n\nAll entered data will be lost.');
                if (confirmed) {
                    // Clear validation classes
                    requiredFields.forEach(field => {
                        field.classList.remove('is-valid', 'is-invalid');
                    });

                    // Clear image preview
                    imagePreview.style.display = 'none';
                    previewImg.src = '';

                    // Reset character counter
                    if (bioCharCount) {
                        bioCharCount.textContent = '0/2000 characters';
                        bioCharCount.classList.remove('text-warning', 'text-danger');
                    }
                } else {
                    e.preventDefault();
                }
            });
        }

        // Name field validation (minimum 3 characters)
        const nameField = document.getElementById('id_name');
        if (nameField) {
            nameField.addEventListener('input', function () {
                const value = this.value.trim();
                if (value.length > 0 && value.length < 3) {
                    this.classList.add('is-invalid');
                    this.classList.remove('is-valid');
                } else if (value.length >= 3) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-invalid', 'is-valid');
                }
            });
        }

        // Nationality field - convert to title case
        const nationalityField = document.getElementById('id_nationality');
        if (nationalityField) {
            nationalityField.addEventListener('blur', function () {
                if (this.value) {
                    this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1).toLowerCase();
                    this.classList.add('is-valid');
                }
            });
        }
    });

    // Function to remove uploaded image
    function removeImage() {
        const photoInput = document.getElementById('id_photo');
        const imagePreview = document.getElementById('imagePreview');

        photoInput.value = '';
        imagePreview.style.display = 'none';
    }
</script>
{% endblock %}